---
title: "Nearshoring en México: Análisis Exploratorio"
author: "David Dominguez - Arturo Silva"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r Banner-portada, echo=FALSE, fig.cap="<small>Foto FOREIGN AFFAIRS LATINOAMÉRICA</small>", out.width='100%'}
knitr::include_graphics("Imagenes/Nearshoring-en-Mexico.jpg")
```


## Librerias

```{r Librerias, message=FALSE, warning=FALSE}
# Manipulación y Transformación de Datos
library(dplyr)       # Manipulación y transformación de datos (filter, mutate, group_by, summarise)
library(tidyr)       # Organización y estructuración de datos en formato "tidy" (spread, gather, pivot_longer, pivot_wider)
library(purrr)       # Programación funcional y manejo de listas
library(janitor)     # Limpieza y formateo de datos (clean_names, remove_empty)

# Importación y Lectura de Archivos
library(readr)       # Lectura rápida de archivos de texto (CSV, TSV, etc.)
library(readxl)      # Importación de archivos Excel

# Visualización de Datos y Gráficos
library(ggplot2)     # Creación de gráficos avanzados y personalizables
library(reshape2)    # Transformación de datos en diferentes estructuras para visualización
library(corrplot)    # Visualización de matrices de correlación
library(rpart.plot)  # Visualización de árboles de decisión

# Modelado y Análisis Estadístico
library(rpart)       # Modelos de árboles de decisión para clasificación y regresión
library(plm)         # Manejo de datos en formato de panel para modelos econométricos

# Manipulación de Cadenas de Texto
library(stringr)     # Manipulación de cadenas de texto (regex, detección de patrones, etc.)
library(stringi)     # Procesamiento avanzado de cadenas (Unicode, conteo de caracteres, etc.)

# Manejo de Fechas y Tiempos
library(lubridate)   # Manipulación de fechas y tiempos en R

# Generación de Informes y Tablas en R Markdown
library(knitr)       # Creación de documentos dinámicos en R Markdown
library(kableExtra)  # Mejora del formato y estilo de las tablas generadas con knitr::kable

# Geoespacial y Mapas
library(sf)          # Análisis y manipulación de datos espaciales en formato "Simple Features"
library(rnaturalearth)        # Obtención de mapas geoespaciales de todo el mundo
library(rnaturalearthdata)    # Conjunto de datos espaciales adicionales para mapas

# Animaciones y Visualización Dinámica
library(gganimate)   # Creación de animaciones en gráficos de R
library(transformr)  # Transiciones suaves en animaciones con gganimate
```

## Dataset

### Glosario:
* **new_fdi:**	New Foreign Direct Investment Inflows. Millions of Dollars.  
* **reinv_profits:**	Reinvestment of Profits - Foreign Direct Investment Inflows. Millions of Dollars.  
* **intercom_acc:**	Intercompany Accounts - Foreign Direct Investment Inflows. Millions of Dollars.  
* **total_fdi:**	Total Foreign Direct Investment Inflows. Millions of Dollars.  
* **crime_rate:**	Crime rate per 100,000 state's population.  
* **unemployment:**	Percentaje of unemployed population.  
* **employment:** 	Percentaje of employed population.  
* **business_activity:**	Index of economic activity weighted by the state's distance to nearest U.S. port of entry.  
* **real_wage:**	Real wage using 2018 INPC = 100. MXN Pesos. 
* **pop_density:**	Population per state's land area km2.  
* **good_governance:**	Ratio between state's public investment and its public debt.  
* **ratio_public_investment:**	Ratio between state's public investment and its gross domestic product (GDP).  
* **lq_primary:**	Location quotient of employed people in primary industry.  
* **lq_secondary:**	Location quotient of employed people in secondary sector.  
* **lq_tertiary	Location:** quotient of employed people in tertiary sector.  
* **exchange_rate:**	MXN pesos per 1 USD  
* **patents_rate:**	Number of R&D patentes per 100,000 state's population  
* **inpc:**	National Price Consumer Index. 2018 = 100  


```{r Dataset, echo=FALSE, message=FALSE, warning=FALSE}
# Read the Excel file
nearshoring <- read_excel('panel_data.xlsx')

# Renombrar columnas
nearshoring <- nearshoring %>%
  rename(region_name = `region...23`, 
         region_num = `region...24`)

# Convert to a panel data frame with 'state' as the cross-section and 'year' as the time variable
#nearshoring <- pdata.frame(nearshoring, index = c("state", "year"))

# Verificar los cambios
colnames(nearshoring)
```

## Overview and Adjustments

b. Crear y/o transformar variables (e.g., variables nominales, variables reales, variables ponderadas, etc.)

```{r Modifications, message=FALSE, warning=FALSE}
# Convertir valores de USD a MXN
nearshoring <- nearshoring %>%
  mutate(across(c(new_fdi, reinv_profits, intercom_acc, total_fdi, exports_miles_dlls), 

                ~ . * exchange_rate, .names = "mxn_{.col}"))

# Ajustar valores a precios reales (2018)
nearshoring <- nearshoring %>%
  mutate(across(c(mxn_new_fdi, mxn_reinv_profits, mxn_intercom_acc, mxn_total_fdi, real_wage, mxn_exports_miles_dlls), 
                ~ . / inpc * 100, .names = "real_{.col}"))

# Convertir region_name a factor para evitar problemas con ggplot2
nearshoring <- nearshoring %>%
  mutate(region_name = as.factor(region_name))

# Subset solo con variables reales en MXN (sin dólares)
nearshoring_clean <- nearshoring %>%
  select(state, year, region_name, region_num, 
         real_mxn_new_fdi, real_mxn_reinv_profits, real_mxn_intercom_acc, 
         real_mxn_total_fdi, real_wage, real_mxn_exports_miles_dlls, 
         crime_rate, unemployment, employment, business_activity, 
         pop_density, good_governance, ratio_public_investment, 
         lq_primary, lq_secondary, lq_tertiary, patents_rate, 
         exchange_rate, inpc, border_distance, trump_election)

# Visualizar primeras filas
head(nearshoring_clean)
```

```{r}
summary(nearshoring_clean)
```


```{r}
nearshoring_numeric <- nearshoring_clean[, !names(nearshoring_clean) %in% c("real_wage", "total_fdi","intercom_acc","reinv_profits","new_fdi","total_fdi", "mxn_total_fdi","mxn_intercom_acc","mxn_reinv_profit","mxn_new_fdi")]

nearshoring_numeric <- nearshoring_numeric[, sapply(nearshoring_numeric, is.numeric)]

cor_matrix <- cor(nearshoring_numeric, use = "complete.obs")

cor_long <- melt(cor_matrix)


ggplot(cor_long, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab",
                       name="Correlación") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Correlation Matrix of Numeric Variables", x = "", y ="")

```

## Analisis Exploratorio

### Estadísticos Descriptivos y de Dispersión

#### Estadísticas Generales  

```{r Estadisticas Generales, echo=FALSE}
# Vector con las variables específicas
variables_interes <- c("pop_density","employment","crime_rate", "business_activity", "border_distance","lq_primary","lq_secondary","lq_tertiary")

# Selecciona las variables específicas y calcula las estadísticas
df_summary <- data.frame(
  #Variable = variables_interes,
  media   = sapply(nearshoring_clean[variables_interes], mean, na.rm = TRUE),
  mínimo  = sapply(nearshoring_clean[variables_interes], min, na.rm = TRUE),
  Q1      = sapply(nearshoring_clean[variables_interes], quantile, 0.25, na.rm = TRUE),
  mediana = sapply(nearshoring_clean[variables_interes], median, na.rm = TRUE),
  Q3      = sapply(nearshoring_clean[variables_interes], quantile, 0.75, na.rm = TRUE),
  máximo  = sapply(nearshoring_clean[variables_interes], max, na.rm = TRUE),
  std     = sapply(nearshoring_clean[variables_interes], sd, na.rm = TRUE)
) %>%
  mutate(across(where(is.numeric), ~ formatC(.,
                                               format = "f",
                                               big.mark = ",",
                                               digits = 2)))

# Genera la tabla en R Markdown
df_summary %>%
  kable(format = "html", caption = "Estadísticas descriptivas por variable") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

#### Nueva Inversión Extranjera

```{r N-FDI Region, echo=FALSE}
# Generación de estadísticas por Región
df_summary <- nearshoring_clean %>%
  group_by(region_name) %>%
  summarise(
    media   = mean(real_mxn_new_fdi, na.rm = TRUE),
    mínimo  = min(real_mxn_new_fdi, na.rm = TRUE),
    Q1      = quantile(real_mxn_new_fdi, 0.25, na.rm = TRUE),
    mediana = median(real_mxn_new_fdi, na.rm = TRUE),
    Q3      = quantile(real_mxn_new_fdi, 0.75, na.rm = TRUE),
    máximo  = max(real_mxn_new_fdi, na.rm = TRUE),
    std     = sd(real_mxn_new_fdi, na.rm = TRUE)
  )%>%
  mutate(across(where(is.numeric), ~ formatC(.,
                                               format = "f",
                                               big.mark = ",",
                                               digits = 2)))

# Visualización de Estadísticas
df_summary %>%
  kable(format = "html", caption = "Comportamiento de la <b>Nueva Inversión Extranjera</b> por región") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```
  
  
    
```{r N-FDI Entidad, echo=FALSE}
df_estadisticas <- nearshoring_clean %>%
  filter(region_name %in% c("Bajio", "Centro","Norte"))

# Generación de estadísticas por Región
df_summary <- df_estadisticas %>%
  group_by(region_name,state) %>%
  summarise(
    media   = mean(real_mxn_new_fdi, na.rm = TRUE),
    mínimo  = min(real_mxn_new_fdi, na.rm = TRUE),
    Q1      = quantile(real_mxn_new_fdi, 0.25, na.rm = TRUE),
    mediana = median(real_mxn_new_fdi, na.rm = TRUE),
    Q3      = quantile(real_mxn_new_fdi, 0.75, na.rm = TRUE),
    máximo  = max(real_mxn_new_fdi, na.rm = TRUE),
    std     = sd(real_mxn_new_fdi, na.rm = TRUE)
  )%>%
  ungroup() %>%
  arrange(region_name,state)%>%
  mutate(across(where(is.numeric), ~ formatC(.,
                                               format = "f",
                                               big.mark = ",",
                                               digits = 2)))

# Visualización de Estadísticas
df_summary %>%
  kable(format = "html", caption = "Comportamiento de la <b>Nueva Inversión Extranjera</b> por Entidad") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

#### Actividad de Negocios
```{r BA Region, echo=FALSE}
# Generación de estadísticas por Región
df_summary <- nearshoring_clean %>%
  group_by(region_name) %>%
  summarise(
    media   = mean(business_activity, na.rm = TRUE),
    mínimo  = min(business_activity, na.rm = TRUE),
    Q1      = quantile(business_activity, 0.25, na.rm = TRUE),
    mediana = median(business_activity, na.rm = TRUE),
    Q3      = quantile(business_activity, 0.75, na.rm = TRUE),
    máximo  = max(business_activity, na.rm = TRUE),
    std     = sd(business_activity, na.rm = TRUE)
  )%>%
  mutate(across(where(is.numeric), ~ formatC(.,
                                               format = "f",
                                               big.mark = ",",
                                               digits = 2)))

# Visualización de Estadísticas
df_summary %>%
  kable(format = "html", caption = "Comportamiento de la <b>Actividad de Negocio</b> por región") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```
  
```{r BA Entidad, echo=FALSE}
df_estadisticas <- nearshoring_clean %>%
  filter(region_name %in% c("Bajio", "Centro","Norte"))

# Generación de estadísticas por Región
df_summary <- df_estadisticas %>%
  group_by(region_name,state) %>%
  summarise(
    media   = mean(business_activity, na.rm = TRUE),
    mínimo  = min(business_activity, na.rm = TRUE),
    Q1      = quantile(business_activity, 0.25, na.rm = TRUE),
    mediana = median(business_activity, na.rm = TRUE),
    Q3      = quantile(business_activity, 0.75, na.rm = TRUE),
    máximo  = max(business_activity, na.rm = TRUE),
    std     = sd(business_activity, na.rm = TRUE)
  )%>%
  ungroup() %>%
  arrange(region_name,state)%>%
  mutate(across(where(is.numeric), ~ formatC(.,
                                               format = "f",
                                               big.mark = ",",
                                               digits = 2)))

# Visualización de Estadísticas
df_summary %>%
  kable(format = "html", caption = "Comportamiento de la <b>Actividad de Negocio</b> por Entidad") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```


### Visualización de los Datos

#### Análisis Univariado



#### Análisis Bivariado

##### Distribución Regional de la Inversión Extranjera Directa en México
```{r}
# Boxplot con color diferente por región
ggplot(nearshoring_clean, aes(x = region_name, y = real_mxn_new_fdi, fill = region_name)) +
  geom_boxplot(color = "black") +  # Color de borde negro
  theme_minimal() +
  labs(title = "Distribución de la Nueva Inversión Extranjera por Región",
       x = "Región", y = "Nueva Inversión Extranjera (MXN reales)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")  # Paleta de colores más visualmente agradable
```

##### Relación entre Inversión Extranjera y Densidad Poblacional
```{r}
# Scatter plot entre real_mxn_new_fdi y pop_density con color de puntos según valor de lq_tertiary
ggplot(nearshoring_clean, aes(x = pop_density, y = sqrt(real_mxn_new_fdi), color = lq_tertiary)) +
  geom_point(alpha = 0.7) +
  scale_x_log10() +  # Escala logarítmica para densidad poblacional
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "Relación entre Raíz Cuadrada de Nueva Inversión Extranjera y Densidad Poblacional",
       x = "Densidad Poblacional (Escala Log)", 
       y = "Raíz Cuadrada de Nueva Inversión Extranjera (MXN reales)",
       color = "LQ Sector Terciario")
```

##### Relación entre Inversión Extranjera y LQ del Sector Primario
```{r}
ggplot(nearshoring_clean, aes(x = lq_primary, y = real_mxn_new_fdi, color = employment)) +
  geom_point(alpha = 0.7) +
  scale_x_log10() +  # Escala logarítmica en el eje X
  scale_y_log10() +  # Escala logarítmica en el eje Y
  scale_color_gradient(low = "blue", high = "red") +  # Mapea el color según employment
  theme_minimal() +
  labs(title = "Relación entre Nueva Inversión Extranjera y LQ del Sector Primario",
       x = "LQ Sector Primario (Escala Log)", 
       y = "Nueva Inversión Extranjera (MXN reales, Escala Log)",
       color = "Employment Rate")
```

##### Relación entre Inversión Extranjera y Tasa de Patentes
```{r}
# Scatter plot entre real_mxn_new_fdi y patents_rate
ggplot(nearshoring_clean, aes(x = patents_rate, y = sqrt(real_mxn_new_fdi))) +
  geom_point(alpha = 0.7, color = "purple") +
  scale_x_log10() +  # Escala logarítmica en el eje X (tasa de patentes)
  theme_minimal() +
  labs(title = "Relación entre Raíz Cuadrada de Nueva Inversión Extranjera y Tasa de Patentes",
       x = "Tasa de Patentes (Escala Log)", 
       y = "Raíz Cuadrada de Nueva Inversión Extranjera (MXN reales)")
```
##### Intensidad de Inversión Extranjera por Estado Acumulada a través de los Años
```{r}
# Obtener el mapa de México con divisiones por estado
mexico_map <- ne_states(country = "Mexico", returnclass = "sf")

# Convertir nombres de estados a minúsculas y eliminar acentos
mexico_map$name <- tolower(mexico_map$name) %>%
  stri_trans_general("Latin-ASCII")  # Normaliza eliminando acentos (Ej. "Nuevo León" -> "Nuevo Leon")

# Asegurar que year sea numérico y calcular inversión acumulativa
nearshoring_clean_df <- nearshoring_clean %>%
  as.data.frame() %>%
  mutate(state = tolower(state) %>% stri_trans_general("Latin-ASCII"),  # Elimina acentos en la base de datos
         year = as.numeric(as.character(year))) %>%
  group_by(state, year) %>%
  summarise(real_mxn_new_fdi = sum(real_mxn_new_fdi, na.rm = TRUE), .groups = "drop") %>%
  arrange(state, year) %>%  # Ordenar por estado y año
  group_by(state) %>%
  mutate(cumulative_fdi = cumsum(real_mxn_new_fdi))  # Crear variable acumulativa

# Unir datos con el mapa
mexico_map <- mexico_map %>%
  left_join(nearshoring_clean_df, by = c("name" = "state"))

# Crear el mapa con animación acumulativa
animated_map <- ggplot(mexico_map) +
  geom_sf(aes(fill = cumulative_fdi), color = "black", size = 0.2) +
  scale_fill_gradient(low = "lightyellow", high = "red", na.value = "gray80") +
  theme_minimal() +
  labs(title = "Evolución Acumulativa de la Inversión Extranjera en México ({closest_state})",
       subtitle = "Valores en MXN reales (Acumulados por Año)",
       fill = "New FDI Acumulado",
       caption = "Fuente: Datos Nearshoring") +
  transition_states(year, transition_length = 2, state_length = 1, wrap = FALSE) +  # Mantiene valores acumulados
  ease_aes('linear')  # Transición lineal entre años

# Guardar el GIF con mayor calidad
anim_save("mapa_inversion_mexico_acumulado.gif", 
          animated_map, 
          renderer = gifski_renderer(loop = TRUE, width = 1200, height = 800),  # Aumentar resolución
          fps = 10,   # Aumentar cuadros por segundo para mayor fluidez
          duration = 15)  # Extender la duración para una transición más suave
```

```{r}
# Insertar el GIF en R Markdown (solo en HTML)
knitr::include_graphics("mapa_inversion_mexico_acumulado.gif")
```

##### Inversión extranjera por región a través del tiempo
```{r}
# Asegurar que year sea numérico y region_name sea factor
nearshoring_clean_df <- nearshoring_clean %>%
  as.data.frame() %>%
  mutate(year = as.numeric(as.character(year)), 
         region_name = as.factor(region_name))

# Graficar la inversión extranjera por región con barras apiladas
ggplot(nearshoring_clean_df, aes(x = factor(year), y = real_mxn_new_fdi, fill = region_name)) +
  geom_bar(stat = "identity", position = "stack") +  # Barras apiladas
  theme_minimal() +
  labs(title = "Distribución de la Inversión Extranjera Directa por Región",
       x = "Año", 
       y = "Nueva Inversión Extranjera (MXN reales, Escala Log)",
       fill = "Región") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Hallazgos



## Referencias

